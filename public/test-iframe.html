<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Portal Iframe</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        padding: 2rem;
        display: flex;
        gap: 2rem;
        background-color: #0f172a; /* slate-900 */
        color: #f1f5f9; /* slate-100 */
      }
      .control-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      label {
        font-weight: 500;
      }
      input,
      select {
        padding: 0.5rem;
        border: 1px solid #334155; /* slate-700 */
        border-radius: 0.25rem;
        background-color: #1e293b; /* slate-800 */
        color: #f1f5f9; /* slate-100 */
      }
      button {
        padding: 0.75rem;
        border: none;
        border-radius: 0.25rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:disabled {
        background-color: #64748b; /* slate-500 */
        cursor: not-allowed;
      }
      button:not(:disabled) {
        background-color: #3b82f6; /* blue-500 */
        color: white;
      }
      button:not(:disabled):hover {
        background-color: #2563eb; /* blue-600 */
      }
      .messages {
        margin-top: 2rem;
        height: 200px;
        overflow-y: auto;
        border: 1px solid #334155; /* slate-700 */
        padding: 0.5rem;
        background-color: #1e293b; /* slate-800 */
      }
      .message {
        padding: 0.5rem;
        border-bottom: 1px solid #334155; /* slate-700 */
      }
      .iframe-container {
        flex: 2;
        display: flex;
        flex-direction: column;
      }
      iframe {
        width: 100%;
        height: 80vh;
        border: 1px solid #334155; /* slate-700 */
      }
    </style>
  </head>
  <body>
    <div class="control-panel">
      <h1>Test Portal Iframe</h1>
      <div class="form-group">
        <label for="domain">Domain</label>
        <input type="text" id="domain" value="" />
      </div>
      <div class="form-group">
        <label for="user-id">User ID</label>
        <input type="text" id="user-id" value="2UTL3rJwbfSq6lFzb08MXgcU4tn1" />
      </div>
      <div class="form-group">
        <label for="user-email">User Email</label>
        <input
          type="email"
          id="user-email"
          value="navicsteinrotciv@gmail.com"
        />
      </div>
      <div class="form-group">
        <label for="language">Language</label>
        <input type="text" id="language" value="english" />
      </div>
      <div class="form-group">
        <label for="portal-type">Portal Type</label>
        <input type="text" id="portal-type" value="adri" />
      </div>
      <button id="activate-btn">Activate Portal</button>

      <div>
        <h2>Received Messages</h2>
        <div id="messages" class="messages"></div>
      </div>
    </div>

    <div class="iframe-container">
      <iframe
        id="portal-iframe"
        src="http://localhost:3000/embed/portal"
        title="Portal Iframe"
        style="width: 100%; height: 100%; border: none;"
        allow="camera; microphone; display-capture;"
      ></iframe>
    </div>

    <script>
      const domainInput = document.getElementById("domain");
      const userIdInput = document.getElementById("user-id");
      const userEmailInput = document.getElementById("user-email");
      const languageInput = document.getElementById("language");
      const portalTypeInput = document.getElementById("portal-type");
      const activateBtn = document.getElementById("activate-btn");
      const messagesDiv = document.getElementById("messages");
      const iframe = document.getElementById("portal-iframe");

      // Pre-fill the domain with the current host
      domainInput.value = window.location.hostname;
      
      // Set the iframe source based on the current host
      function updateIframeSource() {
        const urlParams = new URLSearchParams({
          domain: domainInput.value || window.location.hostname,
          user_id: userIdInput.value,
          user_email: userEmailInput.value,
          language: languageInput.value,
          portalType: portalTypeInput.value,
        });

        const baseUrl = window.location.origin;
        const newSrc = `${baseUrl}/embed/portal?${urlParams.toString()}`;
        console.log("Updating iframe src to:", newSrc);
        iframe.src = newSrc;
      }

      const blacklistedSources = [
        "react-devtools-content-script",
        "react-devtools-background",
        "react-devtools-hook-settings-injector",
        "react-devtools-hook-installer",
      ];
      
      // Listen for messages from the iframe (e.g., conversation_ended)
      window.addEventListener("message", (event) => {
        const { type, payload, source } = event.data || {};
        
        // Skip blacklisted sources
        if (source && blacklistedSources.includes(source)) {
          return;
        }

        // For debugging
        console.log("Received message in test page:", event.data, "from origin:", event.origin);

        // For security, only accept messages from our own origin in this test environment
        if (event.origin !== window.location.origin) {
          console.warn("Message from unexpected origin:", event.origin);
          return;
        }

        // Add message to the log
        if (type) {
          const messageElement = document.createElement("div");
          messageElement.className = "message";
          messageElement.innerHTML = `<strong>${type}</strong> - ${JSON.stringify(
            payload || {}
          )} @ ${new Date().toLocaleTimeString()}`;
          messagesDiv.appendChild(messageElement);
          messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll to bottom
        }
      });

      // Activate the portal when the button is clicked by updating the iframe's src
      activateBtn.addEventListener("click", updateIframeSource);
      
      // Auto-activate on page load
      document.addEventListener('DOMContentLoaded', () => {
        // Small delay to ensure iframe is ready
        setTimeout(updateIframeSource, 500);
      });
    </script>
  </body>
</html>
